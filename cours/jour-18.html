<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jour 18 - Pare-feu et iptables</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
            margin: 10px 0 0 0;
        }
        
        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .section h3 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
            position: relative;
        }
        
        .code-block::before {
            content: "üíª Commande";
            position: absolute;
            top: -10px;
            left: 15px;
            background: #3498db;
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #f39c12;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .warning::before {
            content: "‚ö†Ô∏è ";
            font-weight: bold;
        }
        
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .info::before {
            content: "‚ÑπÔ∏è ";
            font-weight: bold;
        }
        
        .example {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .example::before {
            content: "üìù Exemple : ";
            font-weight: bold;
            color: #155724;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .objectives {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .objectives h3 {
            margin-top: 0;
            color: white;
        }
        
        .objectives ul {
            list-style: none;
            padding: 0;
        }
        
        .objectives li {
            padding: 5px 0;
        }
        
        .objectives li::before {
            content: "üéØ ";
            margin-right: 10px;
        }
        
        .exercise {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .exercise h4 {
            color: #495057;
            margin-top: 0;
        }
        
        .nav-toc {
            background: rgba(52, 73, 94, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .nav-toc h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .nav-toc ul {
            list-style: none;
            padding: 0;
        }
        
        .nav-toc li {
            padding: 5px 0;
        }
        
        .nav-toc a {
            color: #3498db;
            text-decoration: none;
        }
        
        .nav-toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Formation Admin Syst√®me Linux</h1>
            <p>Jour 18 - Pare-feu et iptables</p>
        </div>
        
        <div class="content">
            <div class="objectives">
                <h3>üéØ Objectifs de la formation</h3>
                <ul>
                    <li>Comprendre les concepts fondamentaux des pare-feux</li>
                    <li>Ma√Ætriser l'utilisation d'iptables</li>
                    <li>Configurer des r√®gles de filtrage efficaces</li>
                    <li>Mettre en place une politique de s√©curit√© r√©seau</li>
                    <li>D√©panner et optimiser les configurations</li>
                </ul>
            </div>
            
            <div class="nav-toc">
                <h3>üìã Table des mati√®res</h3>
                <ul>
                    <li><a href="#section1">1. Introduction aux pare-feux</a></li>
                    <li><a href="#section2">2. Architecture d'iptables</a></li>
                    <li><a href="#section3">3. Syntaxe et commandes de base</a></li>
                    <li><a href="#section4">4. Configuration pratique</a></li>
                    <li><a href="#section5">5. R√®gles avanc√©es</a></li>
                    <li><a href="#section6">6. Sauvegarde et restauration</a></li>
                    <li><a href="#section7">7. D√©pannage et optimisation</a></li>
                    <li><a href="#section8">8. Exercices pratiques</a></li>
                </ul>
            </div>
            
            <div class="section" id="section1">
                <h2>1. Introduction aux pare-feux</h2>
                
                <h3>1.1 D√©finition et r√¥le</h3>
                <p>Un pare-feu (firewall) est un syst√®me de s√©curit√© r√©seau qui surveille et contr√¥le le trafic r√©seau entrant et sortant selon des r√®gles de s√©curit√© pr√©d√©finies. Il agit comme une barri√®re entre un r√©seau de confiance (r√©seau interne) et un r√©seau non fiable (Internet).</p>
                
                <h3>1.2 Types de pare-feux</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Avantages</th>
                                <th>Inconv√©nients</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Filtrage de paquets</td>
                                <td>Analyse les en-t√™tes des paquets</td>
                                <td>Rapide, efficace</td>
                                <td>Limit√© au niveau r√©seau</td>
                            </tr>
                            <tr>
                                <td>Stateful</td>
                                <td>Suit l'√©tat des connexions</td>
                                <td>Plus s√©curis√©</td>
                                <td>Plus complexe</td>
                            </tr>
                            <tr>
                                <td>Proxy/Application</td>
                                <td>Analyse au niveau application</td>
                                <td>Tr√®s s√©curis√©</td>
                                <td>Impact sur performance</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h3>1.3 Principe de fonctionnement</h3>
                <p>Les pare-feux fonctionnent selon plusieurs principes :</p>
                <ul>
                    <li><strong>Filtrage par d√©faut :</strong> Tout ce qui n'est pas explicitement autoris√© est interdit</li>
                    <li><strong>R√®gles hi√©rarchiques :</strong> Les r√®gles sont √©valu√©es dans l'ordre</li>
                    <li><strong>Actions possibles :</strong> ACCEPT, DROP, REJECT, LOG</li>
                </ul>
            </div>
            
            <div class="section" id="section2">
                <h2>2. Architecture d'iptables</h2>
                
                <h3>2.1 Structure g√©n√©rale</h3>
                <p>iptables est organis√© en tables, cha√Ænes et r√®gles :</p>
                
                <div class="info">
                    <strong>Tables :</strong> Groupes logiques de r√®gles selon leur fonction<br>
                    <strong>Cha√Ænes :</strong> S√©quences de r√®gles appliqu√©es √† certains moments<br>
                    <strong>R√®gles :</strong> Instructions sp√©cifiques de filtrage
                </div>
                
                <h3>2.2 Les tables principales</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Table</th>
                                <th>Usage</th>
                                <th>Cha√Ænes par d√©faut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>filter</td>
                                <td>Filtrage des paquets (d√©faut)</td>
                                <td>INPUT, OUTPUT, FORWARD</td>
                            </tr>
                            <tr>
                                <td>nat</td>
                                <td>Translation d'adresses</td>
                                <td>PREROUTING, OUTPUT, POSTROUTING</td>
                            </tr>
                            <tr>
                                <td>mangle</td>
                                <td>Modification des paquets</td>
                                <td>PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING</td>
                            </tr>
                            <tr>
                                <td>raw</td>
                                <td>Configuration avant suivi connexion</td>
                                <td>PREROUTING, OUTPUT</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h3>2.3 Les cha√Ænes et leur r√¥le</h3>
                <ul>
                    <li><strong>INPUT :</strong> Paquets destin√©s au syst√®me local</li>
                    <li><strong>OUTPUT :</strong> Paquets g√©n√©r√©s par le syst√®me local</li>
                    <li><strong>FORWARD :</strong> Paquets rout√©s √† travers le syst√®me</li>
                    <li><strong>PREROUTING :</strong> Paquets avant routage</li>
                    <li><strong>POSTROUTING :</strong> Paquets apr√®s routage</li>
                </ul>
                
                <h3>2.4 Flux des paquets</h3>
                <div class="example">
                    <strong>Paquet entrant :</strong><br>
                    PREROUTING ‚Üí (routage) ‚Üí INPUT ‚Üí processus local<br><br>
                    <strong>Paquet sortant :</strong><br>
                    processus local ‚Üí OUTPUT ‚Üí (routage) ‚Üí POSTROUTING<br><br>
                    <strong>Paquet transf√©r√© :</strong><br>
                    PREROUTING ‚Üí (routage) ‚Üí FORWARD ‚Üí POSTROUTING
                </div>
            </div>
            
            <div class="section" id="section3">
                <h2>3. Syntaxe et commandes de base</h2>
                
                <h3>3.1 Syntaxe g√©n√©rale</h3>
                <div class="code-block">
iptables [-t table] commande [cha√Æne] [crit√®res] -j action
                </div>
                
                <h3>3.2 Commandes principales</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Commande</th>
                                <th>Description</th>
                                <th>Exemple</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>-A (--append)</td>
                                <td>Ajouter une r√®gle √† la fin</td>
                                <td><code>iptables -A INPUT -p tcp --dport 22 -j ACCEPT</code></td>
                            </tr>
                            <tr>
                                <td>-I (--insert)</td>
                                <td>Ins√©rer une r√®gle √† une position</td>
                                <td><code>iptables -I INPUT 1 -p tcp --dport 80 -j ACCEPT</code></td>
                            </tr>
                            <tr>
                                <td>-D (--delete)</td>
                                <td>Supprimer une r√®gle</td>
                                <td><code>iptables -D INPUT 1</code></td>
                            </tr>
                            <tr>
                                <td>-L (--list)</td>
                                <td>Lister les r√®gles</td>
                                <td><code>iptables -L -n -v</code></td>
                            </tr>
                            <tr>
                                <td>-F (--flush)</td>
                                <td>Supprimer toutes les r√®gles</td>
                                <td><code>iptables -F INPUT</code></td>
                            </tr>
                            <tr>
                                <td>-P (--policy)</td>
                                <td>D√©finir la politique par d√©faut</td>
                                <td><code>iptables -P INPUT DROP</code></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h3>3.3 Crit√®res de filtrage</h3>
                <h4>Crit√®res g√©n√©raux :</h4>
                <ul>
                    <li><code>-p protocol</code> : Protocole (tcp, udp, icmp, all)</li>
                    <li><code>-s source</code> : Adresse source</li>
                    <li><code>-d destination</code> : Adresse destination</li>
                    <li><code>-i interface</code> : Interface d'entr√©e</li>
                    <li><code>-o interface</code> : Interface de sortie</li>
                </ul>
                
                <h4>Crit√®res TCP/UDP :</h4>
                <ul>
                    <li><code>--sport port</code> : Port source</li>
                    <li><code>--dport port</code> : Port destination</li>
                    <li><code>--tcp-flags masque comparaison</code> : Drapeaux TCP</li>
                </ul>
                
                <h3>3.4 Actions principales</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Description</th>
                                <th>Usage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ACCEPT</td>
                                <td>Autoriser le paquet</td>
                                <td>Trafic l√©gitime</td>
                            </tr>
                            <tr>
                                <td>DROP</td>
                                <td>Rejeter silencieusement</td>
                                <td>S√©curit√© maximale</td>
                            </tr>
                            <tr>
                                <td>REJECT</td>
                                <td>Rejeter avec notification</td>
                                <td>D√©bogage, courtoisie</td>
                            </tr>
                            <tr>
                                <td>LOG</td>
                                <td>Enregistrer dans les logs</td>
                                <td>Audit, surveillance</td>
                            </tr>
                            <tr>
                                <td>SNAT/DNAT</td>
                                <td>Translation d'adresses</td>
                                <td>NAT, redirection</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="section" id="section4">
                <h2>4. Configuration pratique</h2>
                
                <h3>4.1 Visualisation de l'√©tat actuel</h3>
                <div class="code-block">
# Lister toutes les r√®gles avec d√©tails
iptables -L -n -v --line-numbers

# Lister une table sp√©cifique
iptables -t nat -L -n -v

# V√©rifier les politiques par d√©faut
iptables -L | grep policy
                </div>
                
                <h3>4.2 Configuration de base</h3>
                <div class="warning">
                    Attention : Toujours tester les r√®gles avant de les rendre permanentes pour √©viter de se bloquer l'acc√®s !
                </div>
                
                <div class="code-block">
# 1. D√©finir les politiques par d√©faut (restrictives)
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 2. Autoriser le trafic local (loopback)
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# 3. Autoriser les connexions √©tablies et apparent√©es
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 4. Autoriser SSH (remplacez 22 par votre port)
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 5. Autoriser HTTP et HTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
                </div>
                
                <h3>4.3 Exemples de r√®gles courantes</h3>
                
                <h4>Autoriser un service sp√©cifique :</h4>
                <div class="code-block">
# MySQL depuis un r√©seau sp√©cifique
iptables -A INPUT -p tcp -s 192.168.1.0/24 --dport 3306 -j ACCEPT

# DNS
iptables -A INPUT -p udp --dport 53 -j ACCEPT
iptables -A INPUT -p tcp --dport 53 -j ACCEPT

# FTP (mode passif)
iptables -A INPUT -p tcp --dport 21 -j ACCEPT
iptables -A INPUT -p tcp --dport 20000:30000 -j ACCEPT
                </div>
                
                <h4>Limitation par adresse IP :</h4>
                <div class="code-block">
# Bloquer une IP sp√©cifique
iptables -A INPUT -s 192.168.1.100 -j DROP

# Autoriser seulement certaines IPs pour SSH
iptables -A INPUT -p tcp --dport 22 -s 192.168.1.10 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP
                </div>
                
                <h4>Protection contre les attaques :</h4>
                <div class="code-block">
# Protection contre le scan de ports
iptables -A INPUT -m state --state INVALID -j DROP

# Limitation de connexions simultan√©es
iptables -A INPUT -p tcp --dport 22 -m connlimit --connlimit-above 3 -j DROP

# Protection contre le flood SYN
iptables -A INPUT -p tcp --syn -m limit --limit 1/s --limit-burst 3 -j ACCEPT
iptables -A INPUT -p tcp --syn -j DROP
                </div>
            </div>
            
            <div class="section" id="section5">
                <h2>5. R√®gles avanc√©es</h2>
                
                <h3>5.1 Modules iptables</h3>
                <p>iptables supporte de nombreux modules pour des fonctionnalit√©s avanc√©es :</p>
                
                <h4>Module state/conntrack :</h4>
                <div class="code-block">
# Suivi des connexions
iptables -A INPUT -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT

# √âtats possibles : NEW, ESTABLISHED, RELATED, INVALID
                </div>
                
                <h4>Module limit :</h4>
                <div class="code-block">
# Limitation de d√©bit
iptables -A INPUT -p icmp -m limit --limit 1/s --limit-burst 5 -j ACCEPT

# Limitation d'enregistrements de log
iptables -A INPUT -j LOG --log-prefix "DROPPED: " -m limit --limit 2/min
                </div>
                
                <h4>Module multiport :</h4>
                <div class="code-block">
# Plusieurs ports en une seule r√®gle
iptables -A INPUT -p tcp -m multiport --dports 22,80,443 -j ACCEPT
iptables -A INPUT -p tcp -m multiport --sports 1024:65535 -j ACCEPT
                </div>
                
                <h4>Module time :</h4>
                <div class="code-block">
# R√®gles temporelles
iptables -A INPUT -p tcp --dport 80 -m time --timestart 09:00 --timestop 18:00 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -m time --weekdays Mon,Tue,Wed,Thu,Fri -j ACCEPT
                </div>
                
                <h3>5.2 NAT (Network Address Translation)</h3>
                
                <h4>SNAT (Source NAT) :</h4>
                <div class="code-block">
# Masquerading pour partage de connexion
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# SNAT avec IP fixe
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j SNAT --to-source 203.0.113.1
                </div>
                
                <h4>DNAT (Destination NAT) :</h4>
                <div class="code-block">
# Redirection de port
iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.100:80

# Redirection vers serveur interne
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10:80
                </div>
                
                <h3>5.3 Cha√Ænes personnalis√©es</h3>
                <div class="code-block">
# Cr√©er une cha√Æne personnalis√©e
iptables -N LOG_AND_DROP

# Ajouter des r√®gles √† la cha√Æne
iptables -A LOG_AND_DROP -j LOG --log-prefix "Blocked: " --log-level 4
iptables -A LOG_AND_DROP -j DROP

# Utiliser la cha√Æne personnalis√©e
iptables -A INPUT -p tcp --dport 23 -j LOG_AND_DROP
                </div>
            </div>
            
            <div class="section" id="section6">
                <h2>6. Sauvegarde et restauration</h2>
                
                <h3>6.1 M√©thodes de sauvegarde</h3>
                
                <h4>Avec iptables-save/iptables-restore :</h4>
                <div class="code-block">
# Sauvegarder les r√®gles
iptables-save > /etc/iptables/rules.v4

# Restaurer les r√®gles
iptables-restore < /etc/iptables/rules.v4

# Sauvegarde avec horodatage
iptables-save > /backup/iptables-$(date +%Y%m%d_%H%M%S).rules
                </div>
                
                <h4>Script de sauvegarde automatique :</h4>
                <div class="code-block">
#!/bin/bash
# Script de sauvegarde iptables

BACKUP_DIR="/etc/iptables/backup"
DATE=$(date +%Y%m%d_%H%M%S)

# Cr√©er le r√©pertoire si n√©cessaire
mkdir -p $BACKUP_DIR

# Sauvegarder IPv4
iptables-save > $BACKUP_DIR/iptables-$DATE.rules

# Sauvegarder IPv6 si activ√©
ip6tables-save > $BACKUP_DIR/ip6tables-$DATE.rules

echo "Sauvegarde termin√©e : $BACKUP_DIR/iptables-$DATE.rules"
                </div>
                
                <h3>6.2 Persistence des r√®gles</h3>
                
                <h4>Sur Ubuntu/Debian :</h4>
                <div class="code-block">
# Installer le paquet
apt-get install iptables-persistent

# Sauvegarder automatiquement
dpkg-reconfigure iptables-persistent

# Ou manuellement
iptables-save > /etc/iptables/rules.v4
ip6tables-save > /etc/iptables/rules.v6
                </div>
                
                <h4>Sur CentOS/RHEL :</h4>
                <div class="code-block">
# Sauvegarder
service iptables save

# Ou manuellement
iptables-save > /etc/sysconfig/iptables

# Activation au d√©marrage
systemctl enable iptables
                </div>
                
                <h3>6.3 Script de restauration s√©curis√©</h3>
                <div class="code-block">
#!/bin/bash
# Script de restauration avec temporisation

RULES_FILE="/etc/iptables/rules.v4"
TIMEOUT=60

echo "Application des nouvelles r√®gles..."
iptables-restore < $RULES_FILE

echo "Test de la connectivit√© pendant $TIMEOUT secondes..."
echo "Tapez 'ok' pour confirmer, sinon restauration automatique"

read -t $TIMEOUT confirmation

if [ "$confirmation" != "ok" ]; then
    echo "Restauration des r√®gles pr√©c√©dentes..."
    iptables-restore < /etc/iptables/rules.v4.backup
    echo "R√®gles restaur√©es pour s√©curit√©"
else
    echo "Nouvelles r√®gles confirm√©es"
fi
                </div>
            </div>
            
            <div class="section" id="section7">
                <h2>7. D√©pannage et optimisation</h2>
                
                <h3>7.1 Techniques de d√©bogage</h3>
                
                <h4>Logging d√©taill√© :</h4>
                <div class="code-block">
# Activer le logging pour une r√®gle sp√©cifique
iptables -I INPUT -p tcp --dport 80 -j LOG --log-prefix "HTTP: " --log-level 4

# Analyser les logs
tail -f /var/log/kern.log | grep "HTTP:"

# Log et accepter
iptables -A INPUT -p tcp --dport 80 -j LOG --log-prefix "HTTP: "
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
                </div>
                
                <h4>Compteurs et statistiques :</h4>
                <div class="code-block">
# Afficher les compteurs
iptables -L -n -v

# Remettre les compteurs √† z√©ro
iptables -Z

# Surveiller en temps r√©el
watch 'iptables -L -n -v'
                </div>
                
                <h4>Test de connectivit√© :</h4>
                <div class="code-block">
# Tester une connexion sp√©cifique
telnet 192.168.1.10 80

# Tester avec netcat
nc -zv 192.168.1.10 80

# Tester UDP
nc -u -zv 192.168.1.10 53

# Scanner les ports ouverts
nmap -sS localhost
                </div>
                
                <h3>7.2 Probl√®mes courants et solutions</h3>
                
                <div class="warning">
                    <strong>Probl√®me :</strong> Perte de connexion SSH apr√®s modification des r√®gles<br>
                    <strong>Solution :</strong> Toujours garder une session SSH ouverte et tester avec une nouvelle connexion
                </div>
                
                <div class="example">
                    <strong>Proc√©dure s√©curis√©e :</strong><br>
                    1. Ouvrir deux sessions SSH<br>
                    2. Modifier les r√®gles dans la premi√®re<br>
                    3. Tester la connexion avec la seconde<br>
                    4. Si probl√®me, corriger depuis la premi√®re session
                </div>
                
                <h4>Script de r√©cup√©ration automatique :</h4>
                <div class="code-block">
#!/bin/bash
# Script de s√©curit√© - se lance avant modification des r√®gles

# Programmer la restauration dans 5 minutes
echo "iptables -F; iptables -P INPUT ACCEPT; iptables -P OUTPUT ACCEPT; iptables -P FORWARD ACCEPT" | at now + 5 minutes

echo "R√®gles de s√©curit√© programm√©es pour dans 5 minutes"
echo "Annulez avec: atrm [job_number]"
atq
                </div>
                
                <h3>7.3 Optimisation des performances</h3>
                
                <h4>Ordre des r√®gles :</h4>
                <div class="info">
                    Placez les r√®gles les plus fr√©quemment utilis√©es en premier pour optimiser les performances
                </div>
                
                <div class="code-block">
# Mauvais ordre (r√®gles g√©n√©rales en premier)
iptables -A INPUT -j LOG --log-prefix "ALL: "
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# Bon ordre (r√®gles sp√©cifiques en premier)
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -j LOG --log-prefix "OTHER: "
                </div>
                
                <h4>Utilisation de cha√Ænes personnalis√©es :</h4>
                <div class="code-block">
# Cr√©er des cha√Ænes pour organiser les r√®gles
iptables -N SECURITY_RULES
iptables -N WEB_RULES
iptables -N MAIL_RULES

# Rediriger vers les cha√Ænes appropri√©es
iptables -A INPUT -p tcp --dport 80 -j WEB_RULES
iptables -A INPUT -p tcp --dport 443 -j WEB_RULES
iptables -A INPUT -p tcp --dport 25 -j MAIL_RULES
                </div>
                
                <h3>7.4 Monitoring et alertes</h3>
                
                <h4>Script de surveillance :</h4>
                <div class="code-block">
#!/bin/bash
# Script de surveillance iptables

LOG_FILE="/var/log/iptables_monitor.log"
ALERT_THRESHOLD=100

# Compter les paquets dropp√©s
DROPPED=$(iptables -L INPUT -n -v | grep DROP | awk '{sum+=$1} END {print sum}')

if [ "$DROPPED" -gt "$ALERT_THRESHOLD" ]; then
    echo "$(date): ALERTE - $DROPPED paquets dropp√©s" >> $LOG_FILE
    # Envoyer une alerte par email
    echo "Alerte s√©curit√©: $DROPPED paquets bloqu√©s" | mail -s "Alerte Firewall" admin@example.com
fi
                </div>
                
                <h4>Analyse des logs :</h4>
                <div class="code-block">
# Analyser les tentatives de connexion
grep "DPT=22" /var/log/kern.log | awk '{print $13}' | sort | uniq -c | sort -nr

# Top des IPs bloqu√©es
grep "DROPPED:" /var/log/kern.log | awk '{print $11}' | cut -d= -f2 | sort | uniq -c | sort -nr | head -10

# Statistiques par port
grep "DPT=" /var/log/kern.log | awk -F'DPT=' '{print $2}' | awk '{print $1}' | sort | uniq -c | sort -nr
                </div>
            </div>
            
            <div class="section" id="section8">
                <h2>8. Exercices pratiques</h2>
                
                <div class="exercise">
                    <h4>Exercice 1 : Configuration de base</h4>
                    <p><strong>Objectif :</strong> Configurer un pare-feu basique pour un serveur web</p>
                    <p><strong>T√¢ches :</strong></p>
                    <ul>
                        <li>D√©finir une politique restrictive par d√©faut</li>
                        <li>Autoriser SSH (port 22) seulement depuis 192.168.1.0/24</li>
                        <li>Autoriser HTTP (port 80) et HTTPS (port 443) depuis partout</li>
                        <li>Autoriser les connexions √©tablies</li>
                        <li>Logger les connexions refus√©es</li>
                    </ul>
                    
                    <div class="code-block">
# Solution :
# 1. Politiques restrictives
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 2. Trafic local
iptables -A INPUT -i lo -j ACCEPT

# 3. Connexions √©tablies
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 4. SSH restreint
iptables -A INPUT -p tcp -s 192.168.1.0/24 --dport 22 -j ACCEPT

# 5. Services web
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 6. Logging
iptables -A INPUT -j LOG --log-prefix "DROPPED: " --log-level 4
                    </div>
                </div>
                
                <div class="exercise">
                    <h4>Exercice 2 : Protection contre les attaques</h4>
                    <p><strong>Objectif :</strong> Impl√©menter des mesures de protection avanc√©es</p>
                    <p><strong>T√¢ches :</strong></p>
                    <ul>
                        <li>Bloquer les paquets invalides</li>
                        <li>Limiter les connexions SSH simultan√©es</li>
                        <li>Protection contre le flood ICMP</li>
                        <li>Bloquer les scans de ports</li>
                    </ul>
                    
                    <div class="code-block">
# Solution :
# 1. Bloquer les paquets invalides
iptables -A INPUT -m state --state INVALID -j DROP

# 2. Limiter SSH (max 3 connexions par IP)
iptables -A INPUT -p tcp --dport 22 -m connlimit --connlimit-above 3 -j DROP

# 3. Protection ICMP flood
iptables -A INPUT -p icmp -m limit --limit 1/s --limit-burst 5 -j ACCEPT
iptables -A INPUT -p icmp -j DROP

# 4. Protection scan de ports
iptables -A INPUT -p tcp --tcp-flags SYN,ACK,FIN,RST RST -m limit --limit 1/s -j ACCEPT
iptables -A INPUT -p tcp --tcp-flags SYN,ACK,FIN,RST RST -j DROP
                    </div>
                </div>
                
                <div class="exercise">
                    <h4>Exercice 3 : Configuration NAT</h4>
                    <p><strong>Objectif :</strong> Configurer un routeur/passerelle avec NAT</p>
                    <p><strong>T√¢ches :</strong></p>
                    <ul>
                        <li>Activer le forwarding IP</li>
                        <li>Configurer le masquerading</li>
                        <li>Rediriger le port 8080 vers un serveur interne</li>
                        <li>Autoriser le trafic entre r√©seaux</li>
                    </ul>
                    
                    <div class="code-block">
# Solution :
# 1. Activer le forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

# 2. Masquerading
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# 3. Redirection de port
iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.100:80

# 4. Autoriser le forwarding
iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT
                    </div>
                </div>
                
                <div class="exercise">
                    <h4>Exercice 4 : Script de gestion</h4>
                    <p><strong>Objectif :</strong> Cr√©er un script de gestion du pare-feu</p>
                    <p><strong>Fonctionnalit√©s :</strong></p>
                    <ul>
                        <li>Start/Stop/Restart du pare-feu</li>
                        <li>Sauvegarde/Restauration des r√®gles</li>
                        <li>Affichage du statut</li>
                        <li>Mode test avec rollback automatique</li>
                    </ul>
                    
                    <div class="code-block">
#!/bin/bash
# Script de gestion firewall - firewall.sh

RULES_FILE="/etc/iptables/rules.v4"
BACKUP_FILE="/etc/iptables/rules.backup"

case "$1" in
    start)
        echo "D√©marrage du pare-feu..."
        iptables-restore < $RULES_FILE
        echo "Pare-feu activ√©"
        ;;
    stop)
        echo "Arr√™t du pare-feu..."
        iptables -F
        iptables -P INPUT ACCEPT
        iptables -P OUTPUT ACCEPT
        iptables -P FORWARD ACCEPT
        echo "Pare-feu d√©sactiv√©"
        ;;
    restart)
        $0 stop
        sleep 2
        $0 start
        ;;
    save)
        echo "Sauvegarde des r√®gles..."
        iptables-save > $RULES_FILE
        echo "R√®gles sauvegard√©es"
        ;;
    status)
        echo "Statut du pare-feu:"
        iptables -L -n -v
        ;;
    test)
        echo "Mode test activ√© - rollback dans 60s"
        cp $RULES_FILE $BACKUP_FILE
        iptables-restore < $RULES_FILE
        read -t 60 -p "Confirmer les r√®gles? (y/n): " confirm
        if [ "$confirm" != "y" ]; then
            echo "Rollback..."
            iptables-restore < $BACKUP_FILE
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|save|status|test}"
        exit 1
        ;;
esac
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>9. Bonnes pratiques et s√©curit√©</h2>
                
                <h3>9.1 Principes de s√©curit√©</h3>
                <div class="info">
                    <strong>Principe du moindre privil√®ge :</strong> N'autorisez que le strict minimum n√©cessaire<br>
                    <strong>D√©fense en profondeur :</strong> Multipliez les couches de s√©curit√©<br>
                    <strong>Journalisation :</strong> Loggez les √©v√©nements importants pour l'audit
                </div>
                
                <h3>9.2 Checklist de s√©curit√©</h3>
                <ul>
                    <li>‚úÖ Politique par d√©faut restrictive (DROP)</li>
                    <li>‚úÖ Autorisation explicite du trafic n√©cessaire</li>
                    <li>‚úÖ Protection contre les attaques communes</li>
                    <li>‚úÖ Limitation des connexions simultan√©es</li>
                    <li>‚úÖ Journalisation des √©v√©nements suspects</li>
                    <li>‚úÖ Sauvegarde r√©guli√®re des r√®gles</li>
                    <li>‚úÖ Tests r√©guliers de la configuration</li>
                    <li>‚úÖ Mise √† jour des r√®gles selon l'√©volution des besoins</li>
                </ul>
                
                <h3>9.3 Documentation et maintenance</h3>
                <div class="warning">
                    Documentez toujours vos r√®gles de pare-feu ! Utilisez des commentaires explicites et maintenez une documentation √† jour.
                </div>
                
                <div class="code-block">
# Exemple de r√®gles document√©es
# SSH - Acc√®s administrateurs uniquement
iptables -A INPUT -p tcp -s 192.168.1.0/24 --dport 22 -j ACCEPT

# Web - Acc√®s public
iptables -A INPUT -p tcp --dport 80 -j ACCEPT    # HTTP
iptables -A INPUT -p tcp --dport 443 -j ACCEPT   # HTTPS

# Base de donn√©es - Acc√®s serveurs web uniquement
iptables -A INPUT -p tcp -s 192.168.1.10 --dport 3306 -j ACCEPT  # Web1
iptables -A INPUT -p tcp -s 192.168.1.11 --dport 3306 -j ACCEPT  # Web2
                </div>
            </div>
            
            <div class="section">
                <h2>üìö Ressources et r√©f√©rences</h2>
                
                <h3>Documentation officielle</h3>
                <ul>
                    <li>Manuel iptables : <code>man iptables</code></li>
                    <li>Documentation netfilter : <a href="https://netfilter.org/" target="_blank">https://netfilter.org/</a></li>
                    <li>Guide de s√©curit√© Linux</li>
                </ul>
                
                <h3>Outils compl√©mentaires</h3>
                <ul>
                    <li><strong>ufw :</strong> Interface simplifi√©e pour iptables</li>
                    <li><strong>firewalld :</strong> Gestionnaire dynamique de pare-feu</li>
                    <li><strong>fail2ban :</strong> Protection contre les attaques par force brute</li>
                    <li><strong>nftables :</strong> Successeur moderne d'iptables</li>
                </ul>
                
                <h3>Commandes de r√©f√©rence rapide</h3>
                <div class="code-block">
# Commandes essentielles
iptables -L -n -v                    # Lister les r√®gles
iptables -F                          # Vider les r√®gles
iptables -P INPUT DROP               # Politique par d√©faut
iptables -A INPUT -j ACCEPT          # Ajouter une r√®gle
iptables -D INPUT 1                  # Supprimer une r√®gle
iptables-save > fichier              # Sauvegarder
iptables-restore < fichier           # Restaurer
                </div>
            </div>
            
            <div class="section">
                <h2>üéØ R√©sum√© et points cl√©s</h2>
                
                <div class="info">
                    <strong>Points essentiels √† retenir :</strong><br>
                    ‚Ä¢ Les pare-feux filtrent le trafic r√©seau selon des r√®gles d√©finies<br>
                    ‚Ä¢ iptables est l'outil standard sous Linux pour la gestion du filtrage<br>
                    ‚Ä¢ Une approche restrictive par d√©faut am√©liore la s√©curit√©<br>
                    ‚Ä¢ La documentation et les tests sont cruciaux pour une configuration fiable<br>
                    ‚Ä¢ La surveillance continue permet de d√©tecter les anomalies
                </div>
                
                <p>Cette formation vous a donn√© les bases solides pour comprendre et configurer efficacement les pare-feux sous Linux avec iptables. La ma√Ætrise de ces concepts est essentielle pour tout administrateur syst√®me souhaitant s√©curiser ses infrastructures.</p>
            </div>
        </div>
    </div>
</body>
</html>